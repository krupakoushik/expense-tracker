{% extends "base.html" %} 

{% block title %}Home{% endblock %}

{% block content %}

    <h1 align="center">Hello {{ current_user.username.capitalize() }}!</h1>
    <p align="center"><small class="text-body-secondary">Current Balance: </small><b>{{ balance }}</b></p>


    <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><b>Transactions</b></h4>

            
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-dark fw-bold" data-bs-toggle="modal" data-bs-target="#categoryModal">
                    <i class="fa-solid fa-plus"></i> Cat
                </button>
                <button type="button" class="btn btn-outline-dark fw-bold" data-bs-toggle="modal" data-bs-target="#addForm">
                    <i class="fa-solid fa-plus"></i> Add
                </button>
            </div>
    </div>

    <!--Add Transaction Modal-->
    <div id="addForm" class="modal fade" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">

                        <!-- Modal header -->
                        <div class="modal-header">
                            <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <!-- Modal body -->
                        <div class="modal-body">
                            <form method="POST" action="{{ url_for('views.home') }}" class="d-grid gap-3">
                                <input type="hidden" name="form_type" value="transaction">
                                <input type="hidden" name="transaction_id" id="transaction_id">

                                <div class="form-floating">
                                    <input type="date" class="form-control" id="date" name="date" value="{{ current_date }}" required>
                                    <label for="date">Date</label>
                                </div>

                                <div class="form-floating">
                                    <select name="txn" id="txn" class="form-select" required>
                                        <option value="CREDIT">Credit</option>
                                        <option value="DEBIT">Debit</option>
                                    </select>
                                    <label for="txn">Transaction Type</label>
                                </div>

                                <div class="form-floating">
                                    <input type="number" step="0.01" class="form-control" id="amount" name="amount" placeholder="Amount" required>
                                    <label for="amount">Amount</label>
                                </div>

                                <div class="form-floating">
                                    <select name="category_id" id="category_id" class="form-select">
                                        {% for cat in categories %}
                                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <label for="category_id">Category</label>
                                </div>

                                <div class="form-floating">
                                    <input type="text" class="form-control" id="note" name="note" placeholder="Note">
                                    <label for="note">Note</label>
                                </div>

                                <button type="submit" class="btn btn-outline-success fw-bold w-100">
                                    <i class="fa-solid fa-check"></i> Save
                                </button>
                            </form>
                        </div>

                    </div>
                </div>
    </div>

    <!-- Category Modal -->
    <div class="modal fade" data-bs-theme="dark" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">

                        <!-- Modal header -->
                        <div class="modal-header">
                            <h5 class="modal-title" id="categoryModalLabel">Categories</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <!-- Modal body -->
                        <div class="modal-body">
                            <!-- Add Category Form -->
                            <form method="POST" action="{{ url_for('views.home') }}" class="d-grid gap-3" id="categoryForm">
                                <input type="hidden" name="form_type" id="category_form_type" value="category">
                                <input type="hidden" name="form_type" id="categorry_form_type" value="rename-category">
                                <input type="hidden" name="category_idd" id="category_idd" value="">
                                
                                <div class="form-floating">
                                    <input type="text" name="category" id="category_name" class="form-control" placeholder="Category" required>
                                    <label for="category_name" id="category_label">New Category</label>
                                </div>

                                <button type="submit" class="btn btn-outline-success fw-bold w-100" id="category_btn">
                                    <i class="fa-solid fa-check"></i> Add
                                </button>

                            </form>


                            <!-- Existing Categories List -->
                            <ul class="list-group list-group-flush mt-3">
                                {% for cat in categories %}
                                    <li class="list-group-item d-flex">
                                        <span class="p-2 flex-grow-1">{{ cat.name.capitalize() }}</span>

                                        <a href="#" 
                                        class="btn btn-sm btn-outline-warning rename-cat-btn p-2" 
                                        data-id="{{ cat.id }}" 
                                        data-name="{{ cat.name }}">
                                            <i class="fa-solid fa-pen"></i>
                                        </a>

                                        <a href="{{ url_for('views.categoriesdel', id=cat.id) }}" 
                                        class="btn btn-sm btn-outline-danger p-2">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>

                    </div>
                </div>
    </div>

    <table class="table table-hover table-dark">
        <thead align="center" class="table-dark text-center">
        <tr>
            <th scope="col">#</th>
            <th scope="col">Date</th>
            <th scope="col">Amount</th>
            <th scope="col">Type</th>
            <th scope="col">Category</th>
            <th scope="col">Note</th>
            <th scope="col">Actions</th>
        </tr>
        </thead>
        <tbody class="table-group-divider" align="center">
        {% for t in transaction %}
        <tr>
            <td>{{ t.id }}</td>
            <td>{{ t.txn_date.strftime('%d-%m-%Y') if t.txn_date else '' }}</td>
            <td>{{ t.amount }}</td>
            <td>{{ t.txn.capitalize() }}</td>
            <td>
                <form method="POST" action="{{ url_for('views.home') }}">
                    <input type="hidden" name="form_type" value="transaction">
                    <input type="hidden" name="transaction_id" value="{{ t.id }}">
                    <select name="category_id" class="form-select form-select-sm" onchange="this.form.submit()">
                        {% for c in categories %}
                            <option value="{{ c.id }}" {% if t.category_id == c.id %}selected{% endif %}>
                                {{ c.name.capitalize() }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </td>
            <td class="text-truncate" style="max-width: 300px;">{{ t.note }}</td>
            <td>
                <a href="#"
                class="btn btn-outline-warning btn-sm edit-transaction-btn"
                data-id="{{ t.id }}"
                data-date="{{ t.txn_date.strftime('%Y-%m-%d') }}"
                data-txn="{{ t.txn }}"
                data-amount="{{ t.amount }}"
                data-category-id="{{ t.category_id }}"
                data-note="{{ t.note }}">
                <i class="fa-solid fa-pen"></i>
                </a>

                <a href="/delete/{{ t.id }}"
                class="btn btn-outline-danger btn-sm">
                <i class="fa-solid fa-trash"></i>
                </a>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>



    <script>
    document.addEventListener('click', function(e) {
        if (e.target.closest('.rename-cat-btn')) {
            const btn = e.target.closest('.rename-cat-btn');
            document.getElementById('categorry_form_type').value = 'rename-category';
            document.getElementById('category_idd').value = btn.dataset.id;
            document.getElementById('category_name').value = btn.dataset.name;
            document.getElementById('category_label').textContent = 'Rename Category';
            document.getElementById('category_btn').innerHTML = '<i class="fa-solid fa-check"></i> Rename';
        }
    });

    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-transaction-btn')) {
            const btn = e.target.closest('.edit-transaction-btn');
            
            document.getElementById('transaction_id').value = btn.dataset.id;
            document.getElementById('date').value = btn.dataset.date;
            document.getElementById('txn').value = btn.dataset.txn;
            document.getElementById('amount').value = btn.dataset.amount;
            document.getElementById('category_id').value = btn.dataset.categoryId;
            document.getElementById('note').value = btn.dataset.note;

            document.getElementById('transactionModalLabel').textContent = 'Edit Transaction';
            new bootstrap.Modal(document.getElementById('addForm')).show();
        }
    });


    document.addEventListener('hidden.bs.modal', function () {
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
    });
    </script>


{% endblock %}