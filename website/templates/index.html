{% extends "base.html" %} 

{% block title %}Home{% endblock %}

{% block content %}

    <h1 align="center">Hello {{ current_user.username.capitalize() }}!</h1>
    <p align="center"><small class="text-body-secondary">Current Balance: </small><b>{{ balance }}</b></p>

    <div id="addForm" style="display:none; margin-top: 10px; border: 1px solid #ccc ; padding: 15px">
    <form method="POST" action="{{ url_for('views.home') }}">
        <input type="hidden" name="form_type" value="transaction">
        <label for="date" class="form-label">Date:</label>
        <input type="date" class="form-control" name="date" required>
        
        <label for="txn" class="form-label" >Type:</label>
        <select name="txn" class="form-control" required>
            <option value="CREDIT">Credit</option>
            <option value="DEBIT">Debit</option>
        </select>
        
        <label for="amount" class="form-label">Amount:</label>
        <input type="number" step="0.01" name="amount" class="form-control" placeholder="Amount" required>
        

        <label for="category_id" class="form-label">Category:</label>
        <select name="category_id" class="form-control" placeholder="Category">
            {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
        </select>


        <label for="note" class="form-label">Note:</label>
        <input type="text" name="note" class="form-control" placeholder="Note">
        
        <input type="submit" value="Submit">
    </form>
    </div>

    <table class="table table-hover table-dark">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><b>All Transactions</b></h4>
            <a href="#" class="btn">
                <button type="button" data-bs-toggle="modal" data-bs-target="#categoryModal">
                    ➕ Manage Categories
                </button>
                <button onclick="toggleForm()" id="toggleBtn">➕ Add Transaction</button>
            </a>

            <!-- Modal -->
            <div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">

                        <!-- Modal header -->
                        <div class="modal-header">
                            <h5 class="modal-title" id="categoryModalLabel">Categories</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <!-- Modal body -->
                        <div class="modal-body">
                            <!-- Add Category Form -->
                            <form method="POST" action="{{ url_for('views.home') }}" class="d-flex mb-3">
                                <input type="hidden" name="form_type" value="category">
                                <input type="text" name="category" class="form-control me-2" placeholder="New Category" required>
                                <button type="submit" class="btn btn-success">Add</button>
                            </form>


                            <!-- Existing Categories List -->
                            <ul class="list-group">
                                {% for cat in categories %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ cat.name }}
                                        <a href="{{ url_for('views.categoriesdel', id=cat.id) }}" class="btn btn-sm btn-danger">Delete</a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- Modal footer -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        
        <thead align="center" class="table-dark">
        <tr>
            <th scope="col">ID</th>
            <th scope="col">Date</th>
            <th scope="col">Amount</th>
            <th scope="col">Type</th>
            <th scope="col">Category</th>
            <th scope="col">Note</th>
            <th scope="col">Actions</th>
        </tr>
        </thead>
        <tbody class="table-group-divider" align="center">
        {% for t in transaction %}
        <tr>
            <th>{{ t.id }}</th>
            <th>{{ t.txn_date.strftime('%d-%m-%Y') if t.txn_date else '' }}</th>
            <th>{{ t.amount }}</th>
            <th>{{ t.txn.capitalize() }}</th>
            <th>
                <form method="POST" action="{{ url_for('views.update_category', id=t.id) }}">
                    <select name="category_id" class="form-select form-select-sm" onchange="this.form.submit()">
                        {% for c in categories %}
                            <option value="{{ c.id }}" {% if t.category_id == c.id %}selected{% endif %}>
                                {{ c.name.capitalize() }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </th>
            <th>{{ t.note.capitalize() }}</th>
            <th>
                <a class="btn btn-dark btn-sm" href="/edit/{{ t.id }}" role="button">Edit</a>
                <a class="btn btn-dark btn-sm" href="/delete/{{ t.id }}" role="button">Delete</a>
            </th>
        </tr>
        {% endfor %}
        </tbody>
    </table>



    <script>
        function toggleForm(){
            let form = document.getElementById("addForm");
            let btn = document.getElementById("toggleBtn");

            if (form.style.display === "none"){
                form.style.display = "block";
                btn.textContent = "➖ Hide Form";
            }
            else {
                form.style.display = "none";
                btn.textContent = "➕ Add Transaction";
            }
        }

        const myModal = document.getElementById('myModal')
        const myInput = document.getElementById('myInput')

        myModal.addEventListener('shown.bs.modal', () => {
        myInput.focus()
        })
    </script>




{% endblock %}